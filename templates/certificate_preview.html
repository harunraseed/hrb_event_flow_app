<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Preview - {{ event.name }}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #f8f9fa;
        }
        
        /* Ensure all interactions work */
        * {
            pointer-events: auto !important;
        }
        
        .btn {
            cursor: pointer !important;
            pointer-events: auto !important;
        }
        
        .form-control, .form-select {
            cursor: text !important;
            pointer-events: auto !important;
            background-color: white !important;
        }
        
        .form-select {
            cursor: pointer !important;
        }
        
        .form-check-input {
            cursor: pointer !important;
        }
        
        input[type="file"] {
            cursor: pointer !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1><i class="bi bi-award"></i> Certificate Preview - {{ event.name }}</h1>
                    <a href="{{ url_for('event_dashboard', event_id=event.id) }}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Certificate Form -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-gear"></i> Certificate Configuration
                            {% if event.has_certificate_config %}
                                <span class="badge bg-success ms-2">
                                    <i class="bi bi-check-circle"></i> Configuration Saved
                                </span>
                            {% else %}
                                <span class="badge bg-warning ms-2">
                                    <i class="bi bi-exclamation-triangle"></i> Not Configured
                                </span>
                            {% endif %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" id="certificateForm" enctype="multipart/form-data" 
                              action="{{ url_for('save_certificate_config', event_id=event.id) }}">
                            {{ form.hidden_tag() }}
                            
                            <!-- Basic Settings -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label for="certificate_type" class="form-label">Certificate Type</label>
                                    {{ form.certificate_type(class="form-select") }}
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="organizer_name" class="form-label">Organizer Name</label>
                                    {{ form.organizer_name(class="form-control") }}
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="sponsor_name" class="form-label">Sponsor Name</label>
                                    {{ form.sponsor_name(class="form-control") }}
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="event_location" class="form-label">Event Location</label>
                                    {{ form.event_location(class="form-control") }}
                                </div>
                                
                                <div class="col-12">
                                    <label for="event_theme" class="form-label">Event Theme</label>
                                    {{ form.event_theme(class="form-control") }}
                                </div>
                            </div>
                            
                            <!-- File Uploads -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h6 class="text-primary">Logo Configuration</h6>
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="organizer_logo_file" class="form-label">Organizer Logo Upload</label>
                                    {{ form.organizer_logo_file(class="form-control") }}
                                    {% if form.organizer_logo_url.data %}
                                    <div class="mt-2">
                                        <small class="text-success">
                                            <i class="bi bi-check-circle"></i> Logo already uploaded
                                            <a href="{{ form.organizer_logo_url.data }}" target="_blank" class="ms-2">
                                                <i class="bi bi-eye"></i> View
                                            </a>
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="organizer_logo_url" class="form-label">Or Organizer Logo URL</label>
                                    {{ form.organizer_logo_url(class="form-control", placeholder="https://example.com/logo.png") }}
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="sponsor_logo_file" class="form-label">Sponsor Logo Upload</label>
                                    {{ form.sponsor_logo_file(class="form-control") }}
                                    {% if form.sponsor_logo_url.data %}
                                    <div class="mt-2">
                                        <small class="text-success">
                                            <i class="bi bi-check-circle"></i> Logo already uploaded
                                            <a href="{{ form.sponsor_logo_url.data }}" target="_blank" class="ms-2">
                                                <i class="bi bi-eye"></i> View
                                            </a>
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="sponsor_logo_url" class="form-label">Or Sponsor Logo URL</label>
                                    {{ form.sponsor_logo_url(class="form-control", placeholder="https://example.com/sponsor-logo.png") }}
                                </div>
                                
                                <!-- Signature 1 Fields -->
                                <div class="col-12 mt-4">
                                    <h6 class="text-primary">Signature Configuration</h6>
                                </div>
                                <div class="col-md-6 mt-3">
                                    <label for="signature1_name" class="form-label">First Signatory Name</label>
                                    {{ form.signature1_name(class="form-control") }}
                                </div>
                                <div class="col-md-6 mt-3">
                                    <label for="signature1_title" class="form-label">First Signatory Title</label>
                                    {{ form.signature1_title(class="form-control") }}
                                </div>
                                <div class="col-md-6 mt-3">
                                    <label for="signature1_file" class="form-label">First Signature Upload</label>
                                    {{ form.signature1_file(class="form-control") }}
                                    {% if form.signature1_image_url.data %}
                                    <div class="mt-2">
                                        <small class="text-success">
                                            <i class="bi bi-check-circle"></i> Signature already uploaded
                                            <a href="{{ form.signature1_image_url.data }}" target="_blank" class="ms-2">
                                                <i class="bi bi-eye"></i> View
                                            </a>
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mt-3">
                                    <label for="signature1_image_url" class="form-label">Or First Signature URL</label>
                                    {{ form.signature1_image_url(class="form-control", placeholder="https://example.com/signature1.png") }}
                                </div>
                                <!-- Signature 2 Fields -->
                                <div class="col-md-6 mt-3">
                                    <label for="signature2_name" class="form-label">Second Signatory Name</label>
                                    {{ form.signature2_name(class="form-control") }}
                                </div>
                                <div class="col-md-6 mt-3">
                                    <label for="signature2_title" class="form-label">Second Signatory Title</label>
                                    {{ form.signature2_title(class="form-control") }}
                                </div>
                                <div class="col-md-6 mt-3">
                                    <label for="signature2_file" class="form-label">Second Signature Upload</label>
                                    {{ form.signature2_file(class="form-control") }}
                                    {% if form.signature2_image_url.data %}
                                    <div class="mt-2">
                                        <small class="text-success">
                                            <i class="bi bi-check-circle"></i> Signature already uploaded
                                            <a href="{{ form.signature2_image_url.data }}" target="_blank" class="ms-2">
                                                <i class="bi bi-eye"></i> View
                                            </a>
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mt-3">
                                    <label for="signature2_image_url" class="form-label">Or Second Signature URL</label>
                                    {{ form.signature2_image_url(class="form-control", placeholder="https://example.com/signature2.png") }}
                                </div>
                            </div>
                            
                            <!-- Recipients -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="form-check">
                                        {{ form.send_to_all_checked_in(class="form-check-input") }}
                                        {{ form.send_to_all_checked_in.label(class="form-check-label") }}
                                    </div>
                                </div>
                            </div>
                            
                            <div id="saveResult" class="mt-3" style="display: none;">
                                <!-- Success/error messages will appear here -->
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="d-flex gap-3">
                                <button type="button" class="btn btn-primary" onclick="previewCertificate()">
                                    <i class="bi bi-eye"></i> Preview Certificate
                                </button>
                                
                                <button type="button" class="btn btn-outline-primary" onclick="saveCertificateConfig()" id="saveConfigBtn">
                                    <i class="bi bi-floppy"></i> Save Configuration
                                </button>
                                
                                <button type="button" class="btn btn-success" onclick="confirmSendCertificates()">
                                    <i class="bi bi-award"></i> Generate & Send Certificates
                                    <span class="badge bg-light text-dark ms-2">{{ eligible_for_certificate }}</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-primary">{{ total_participants }}</h4>
                        <p class="card-text">Total Participants</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-success">{{ checked_in_count }}</h4>
                        <p class="card-text">Checked In</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-warning">{{ eligible_for_certificate }}</h4>
                        <p class="card-text">Eligible for Certificate</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-info">{{ already_issued }}</h4>
                        <p class="card-text">Already Issued</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Eligible Participants Table -->
        {% if eligible_participants %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-people"></i> Participants Eligible for Certificates</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Check-in Status</th>
                                        <th>Check-in Time</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for participant in eligible_participants %}
                                    <tr>
                                        <td>{{ participant.name }}</td>
                                        <td>{{ participant.email }}</td>
                                        <td><span class="badge bg-success">Checked In</span></td>
                                        <td>{{ participant.checkin_time.strftime('%m/%d/%Y %I:%M %p') if participant.checkin_time else '-' }}</td>
                                        <td>
                                            <a href="{{ url_for('preview_single_certificate', participant_id=participant.id) }}" 
                                               class="btn btn-sm btn-outline-primary" target="_blank">
                                                <i class="bi bi-eye"></i> Preview
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Certificate Preview Modal -->
    <div class="modal fade" id="certificatePreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-award"></i> Certificate Preview
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <iframe id="certificatePreviewFrame" style="width: 100%; height: 600px; border: none;"></iframe>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        console.log('üöÄ Certificate page loaded');
        
        function previewCertificate() {
            console.log('üîç Preview certificate clicked');
            
            try {
                // Use a simplified preview URL that relies on saved event configuration
                const previewUrl = "{{ url_for('preview_certificate', event_id=event.id) }}";
                console.log('üìÑ Preview URL:', previewUrl);
                
                // Set iframe source
                const iframe = document.getElementById('certificatePreviewFrame');
                if (iframe) {
                    iframe.src = previewUrl;
                    console.log('‚úÖ Iframe source set');
                } else {
                    console.log('‚ùå Preview iframe not found');
                }
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('certificatePreviewModal'));
                modal.show();
                
            } catch (error) {
                console.error('‚ùå Preview error:', error);
                alert('Error previewing certificate: ' + error.message);
            }
        }
        
        function saveCertificateConfig() {
            console.log('üîß Save config clicked');
            
            const saveBtn = document.getElementById('saveConfigBtn');
            const resultDiv = document.getElementById('saveResult');
            
            // Disable button and show loading
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
            
            const form = document.getElementById('certificateForm');
            const formData = new FormData(form);
            
            console.log('üìã Form data being sent:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: ${value}`);
            }
            
            // Use fetch to submit via AJAX so we can handle the response
            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('üì• Response status:', response.status);
                if (response.ok) {
                    // Success
                    resultDiv.className = 'alert alert-success mt-3';
                    resultDiv.innerHTML = '<i class="bi bi-check-circle"></i> Configuration saved successfully!';
                    resultDiv.style.display = 'block';
                    console.log('‚úÖ Configuration saved successfully');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            })
            .catch(error => {
                console.error('‚ùå Save error:', error);
                resultDiv.className = 'alert alert-danger mt-3';
                resultDiv.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Error saving configuration: ' + error.message;
                resultDiv.style.display = 'block';
            })
            .finally(() => {
                // Re-enable button
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="bi bi-floppy"></i> Save Configuration';
            });
        }
        
        function confirmSendCertificates() {
            const confirmed = confirm('Generate and send certificates to all eligible participants?');
            if (confirmed) {
                console.log('Generate certificates confirmed');
                const form = document.getElementById('certificateForm');
                form.action = "{{ url_for('generate_certificates', event_id=event.id) }}";
                form.submit();
            }
        }
        
        // Test form interactions
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM ready');
            
            // Add change listeners to test form fields
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('change', function() {
                    console.log('‚úÖ Form field changed:', this.id, this.value);
                });
                
                input.addEventListener('focus', function() {
                    console.log('üéØ Form field focused:', this.id);
                });
            });
            
            console.log('‚úÖ Form interaction listeners added');
        });
    </script>
</body>
</html>