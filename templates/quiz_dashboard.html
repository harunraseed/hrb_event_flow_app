{% extends "base.html" %}

{% block title %}Quiz Dashboard - {{ event.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="fas fa-brain text-primary"></i> Quiz Dashboard</h2>
            <p class="text-muted">Manage quiz for <strong>{{ event.name }}</strong></p>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
                <a href="{{ url_for('event_dashboard', event_id=event.id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Event
                </a>
                <a href="{{ url_for('quiz_leaderboard', event_id=event.id) }}" class="btn btn-info">
                    <i class="fas fa-trophy"></i> Leaderboard
                </a>
                <a href="{{ url_for('quiz_share', event_id=event.id) }}" class="btn btn-warning">
                    <i class="fas fa-share-alt"></i> Share Quiz
                </a>
                <a href="{{ url_for('quiz_gamemaster', event_id=event.id) }}" class="btn btn-success">
                    <i class="fas fa-tachometer-alt"></i> Live Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Quiz Status & Controls -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-cog"></i> Quiz Status</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <p><strong>Status:</strong></p>
                            {% if quiz.is_active %}
                                <span class="badge bg-success fs-6">ðŸŸ¢ Active</span>
                            {% elif quiz.is_ended %}
                                <span class="badge bg-danger fs-6">ðŸ”´ Ended</span>
                            {% else %}
                                <span class="badge bg-secondary fs-6">âšª Not Started</span>
                            {% endif %}
                        </div>
                        <div class="col-6">
                            <p><strong>Time per Question:</strong> {{ quiz.time_per_question }}s</p>
                            {% if quiz.total_time_limit %}
                                <p><strong>Total Time Limit:</strong> {{ quiz.total_time_limit }}s</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        {% if not quiz.is_started and stats.total_questions > 0 %}
                            <button class="btn btn-success" onclick="startQuiz()">
                                <i class="fas fa-play"></i> Start Quiz
                            </button>
                        {% elif quiz.is_active %}
                            <button class="btn btn-danger" onclick="endQuiz()">
                                <i class="fas fa-stop"></i> End Quiz
                            </button>
                        {% endif %}
                        
                        <a href="{{ url_for('quiz_config', event_id=event.id) }}" class="btn btn-outline-primary">
                            <i class="fas fa-cog"></i> Configure
                        </a>
                        
                        <!-- Quiz Management Actions -->
                        <div class="btn-group mt-2" role="group">
                            <button class="btn btn-outline-warning btn-sm" onclick="resetQuiz()">
                                <i class="fas fa-redo"></i> Reset Quiz
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteQuiz()">
                                <i class="fas fa-trash"></i> Delete Quiz
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 class="text-primary">{{ stats.total_questions }}</h4>
                            <small>Questions</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-success">{{ stats.total_attempts }}</h4>
                            <small>Attempts</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-warning">{{ stats.completed_attempts }}</h4>
                            <small>Completed</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 class="text-info">{{ stats.average_score }}</h4>
                            <small>Avg Score</small>
                        </div>
                        <div class="col-4">
                            <h4 class="{% if quiz.is_full %}text-danger{% else %}text-primary{% endif %}">
                                {{ quiz.current_participants }}/{{ quiz.participant_limit }}
                            </h4>
                            <small>Participants</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-success">{{ quiz.available_spots }}</h4>
                            <small>Spots Left</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Sharing Security Notice -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-1"><i class="fas fa-shield-alt text-primary"></i> Secure Quiz Sharing</h5>
                        <p class="mb-0">QR codes and sharing links have been moved to a separate page to prevent participants from seeing questions.</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <a href="{{ url_for('quiz_share', event_id=event.id) }}" class="btn btn-primary">
                            <i class="fas fa-share-alt"></i> Share Quiz Safely
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Questions Management -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-question-circle"></i> Questions ({{ stats.total_questions }})</h5>
                    <div class="btn-group">
                        <button id="toggleQuestions" class="btn btn-warning btn-sm" onclick="toggleQuestionVisibility()">
                            <i class="fas fa-eye-slash"></i> <span id="toggleText">Show Questions</span>
                        </button>
                        <a href="{{ url_for('add_quiz_question', event_id=event.id) }}" class="btn btn-success btn-sm">
                            <i class="fas fa-plus"></i> Add Question
                        </a>
                        <a href="{{ url_for('upload_quiz_questions', event_id=event.id) }}" class="btn btn-primary btn-sm">
                            <i class="fas fa-upload"></i> Upload CSV
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning" id="securityNotice">
                        <i class="fas fa-shield-alt"></i> <strong>Security Notice:</strong> Questions are hidden by default to prevent participants from seeing them when you share your screen or show the QR code. Click "Show Questions" to preview.
                    </div>
                    {% if questions %}
                        <div class="table-responsive" id="questionsTable" style="display: none;">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th width="5%">#</th>
                                        <th width="50%">Question</th>
                                        <th width="20%">Options</th>
                                        <th width="10%">Correct Answer</th>
                                        <th width="8%">Points</th>
                                        <th width="7%">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for question in questions %}
                                    <tr>
                                        <td><span class="badge bg-primary">{{ question.question_order }}</span></td>
                                        <td>
                                            <div class="question-preview fw-bold">
                                                {{ question.question_text }}
                                            </div>
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                <div><strong>A:</strong> {{ question.option_a }}</div>
                                                <div><strong>B:</strong> {{ question.option_b }}</div>
                                                <div><strong>C:</strong> {{ question.option_c }}</div>
                                                <div><strong>D:</strong> {{ question.option_d }}</div>
                                            </small>
                                        </td>
                                        <td>
                                            <span class="badge bg-success fs-6">{{ question.correct_answer }}</span>
                                        </td>
                                        <td><span class="badge bg-info">{{ question.points }}</span></td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" 
                                                    onclick="deleteQuestion({{ question.id }})"
                                                    title="Delete Question">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center py-4" id="questionsHidden">
                            <i class="fas fa-eye-slash fa-3x text-muted mb-3"></i>
                            <h5>{{ stats.total_questions }} Questions Hidden</h5>
                            <p class="text-muted">Click "Show Questions" above to preview questions and answers safely.</p>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-question-circle fa-3x text-muted mb-3"></i>
                            <h5>No Questions Added</h5>
                            <p class="text-muted">Start by adding questions manually or uploading a CSV file.</p>
                            <div class="mt-3">
                                <a href="{{ url_for('add_quiz_question', event_id=event.id) }}" class="btn btn-success">
                                    <i class="fas fa-plus"></i> Add First Question
                                </a>
                                <a href="{{ url_for('upload_quiz_questions', event_id=event.id) }}" class="btn btn-primary ms-2">
                                    <i class="fas fa-upload"></i> Upload CSV
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Attempts -->
    {% if attempts %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-users"></i> Recent Attempts</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Participant</th>
                                    <th>Score</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                    <th>Started</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for attempt in attempts[-10:] %}
                                <tr>
                                    <td>{{ attempt.participant.name }}</td>
                                    <td>
                                        <span class="badge bg-primary">{{ attempt.score }}</span>
                                    </td>
                                    <td>
                                        {% if attempt.is_completed %}
                                            <span class="badge bg-success">Completed</span>
                                        {% else %}
                                            <span class="badge bg-warning">In Progress</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if attempt.total_time_taken %}
                                            {{ attempt.total_time_taken }}s
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>{{ attempt.started_at.strftime('%H:%M') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function startQuiz() {
    if (confirm('Are you sure you want to start the quiz? This will allow participants to join.')) {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch(`/event/{{ event.id }}/quiz/start`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error occurred');
        });
    }
}

function endQuiz() {
    if (confirm('Are you sure you want to end the quiz? This will stop all participation.')) {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch(`/event/{{ event.id }}/quiz/end`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error occurred');
        });
    }
}

function copyQuizLink() {
    const linkInput = document.getElementById('quizLink');
    linkInput.select();
    linkInput.setSelectionRange(0, 99999);
    document.execCommand('copy');
    
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i> Copied!';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-success');
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }, 2000);
}

function deleteQuestion(questionId) {
    if (confirm('Are you sure you want to delete this question?')) {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch(`/event/{{ event.id }}/quiz/question/${questionId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error occurred');
        });
    }
}

function deleteQuiz() {
    const quizTitle = "{{ quiz.title }}";
    const participantCount = {{ stats.total_attempts }};
    
    if (confirm(`âš ï¸ WARNING: This will permanently delete the entire quiz "${quizTitle}" and ALL related data including:\n\nâ€¢ ${participantCount} participant attempts\nâ€¢ All quiz questions\nâ€¢ All quiz answers\nâ€¢ Quiz configuration\n\nThis action CANNOT be undone!\n\nAre you sure you want to delete this quiz?`)) {
        const userConfirmation = prompt('Type "DELETE QUIZ" to confirm:');
        if (userConfirmation === 'DELETE QUIZ') {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            fetch(`/event/{{ event.id }}/quiz/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.href = `/event/{{ event.id }}/dashboard`;
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Network error occurred');
            });
        } else {
            alert('Quiz deletion cancelled - incorrect confirmation text.');
        }
    }
}

function resetQuiz() {
    const participantCount = {{ stats.total_attempts }};
    
    if (confirm(`âš ï¸ This will reset the quiz and remove all participant data:\n\nâ€¢ ${participantCount} participant attempts will be deleted\nâ€¢ All quiz answers will be removed\nâ€¢ Quiz will be stopped and reset to inactive\nâ€¢ Questions and configuration will be kept\n\nParticipants will need to rejoin the quiz.\n\nAre you sure you want to reset this quiz?`)) {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch(`/event/{{ event.id }}/quiz/reset`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error occurred');
        });
    }
}

function printQR() {
    const qrImg = document.querySelector('img[alt="Quiz QR Code"]');
    const printWindow = window.open('', '', 'width=400,height=400');
    printWindow.document.write(`
        <html>
        <head>
            <title>Quiz QR Code</title>
            <style>
                body { text-align: center; padding: 20px; font-family: Arial, sans-serif; }
                img { max-width: 300px; }
                h3 { margin-bottom: 10px; }
                p { font-size: 12px; color: #666; }
            </style>
        </head>
        <body>
            <h3>Join Quiz: {{ event.name }}</h3>
            <img src="${qrImg.src}" alt="Quiz QR Code">
            <p>Scan with your mobile device to join the quiz</p>
            <p>${window.location.origin}/event/{{ event.id }}/quiz/play</p>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
}

function toggleQuestionVisibility() {
    const table = document.getElementById('questionsTable');
    const hiddenDiv = document.getElementById('questionsHidden');
    const toggleBtn = document.getElementById('toggleQuestions');
    const toggleText = document.getElementById('toggleText');
    const securityNotice = document.getElementById('securityNotice');
    
    if (table.style.display === 'none') {
        // Show questions
        table.style.display = 'block';
        if (hiddenDiv) hiddenDiv.style.display = 'none';
        securityNotice.className = 'alert alert-danger';
        securityNotice.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <strong>Questions Visible:</strong> Questions and answers are now visible. Be careful when sharing your screen or showing to participants.';
        toggleBtn.className = 'btn btn-danger btn-sm';
        toggleBtn.innerHTML = '<i class="fas fa-eye"></i> <span id="toggleText">Hide Questions</span>';
    } else {
        // Hide questions
        table.style.display = 'none';
        if (hiddenDiv) hiddenDiv.style.display = 'block';
        securityNotice.className = 'alert alert-warning';
        securityNotice.innerHTML = '<i class="fas fa-shield-alt"></i> <strong>Security Notice:</strong> Questions are hidden by default to prevent participants from seeing them when you share your screen or show the QR code. Click "Show Questions" to preview.';
        toggleBtn.className = 'btn btn-warning btn-sm';
        toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> <span id="toggleText">Show Questions</span>';
    }
}

// copyQuizLink function removed - now handled in quiz_share.html

function deleteQuestion(questionId) {
    if (confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch(`/event/{{ event.id }}/quiz/question/${questionId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error occurred');
        });
    }
}
</script>
{% endblock %}