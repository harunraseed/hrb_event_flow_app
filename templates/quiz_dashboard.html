{% extends "base.html" %}

{% block title %}Quiz Dashboard - {{ event.name }}{% endblock %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="fas fa-brain text-primary"></i> Quiz Dashboard</h2>
            <p class="text-muted">Manage quiz for <strong>{{ event.name }}</strong></p>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
                <a href="{{ url_for('event_dashboard', event_id=event.id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Event
                </a>
                <a href="{{ url_for('quiz_leaderboard', event_id=event.id) }}" class="btn btn-info">
                    <i class="fas fa-trophy"></i> Leaderboard
                </a>
                <a href="{{ url_for('quiz_gamemaster', event_id=event.id) }}" class="btn btn-success">
                    <i class="fas fa-tachometer-alt"></i> Live Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Quiz Status & Controls -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-cog"></i> Quiz Status</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <p><strong>Status:</strong></p>
                            {% if quiz.is_active %}
                                <span class="badge bg-success fs-6">ðŸŸ¢ Active</span>
                            {% elif quiz.is_ended %}
                                <span class="badge bg-danger fs-6">ðŸ”´ Ended</span>
                            {% else %}
                                <span class="badge bg-secondary fs-6">âšª Not Started</span>
                            {% endif %}
                        </div>
                        <div class="col-6">
                            <p><strong>Time per Question:</strong> {{ quiz.time_per_question }}s</p>
                            {% if quiz.total_time_limit %}
                                <p><strong>Total Time Limit:</strong> {{ quiz.total_time_limit }}s</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        {% if not quiz.is_started and stats.total_questions > 0 %}
                            <button class="btn btn-success" onclick="startQuiz()">
                                <i class="fas fa-play"></i> Start Quiz
                            </button>
                        {% elif quiz.is_active %}
                            <button class="btn btn-danger" onclick="endQuiz()">
                                <i class="fas fa-stop"></i> End Quiz
                            </button>
                        {% endif %}
                        
                        <a href="{{ url_for('quiz_config', event_id=event.id) }}" class="btn btn-outline-primary">
                            <i class="fas fa-cog"></i> Configure
                        </a>
                        
                        <!-- Quiz Management Actions -->
                        <div class="btn-group mt-2" role="group">
                            {% if stats.total_attempts > 0 %}
                                <button class="btn btn-outline-warning btn-sm" onclick="resetQuiz()">
                                    <i class="fas fa-redo"></i> Reset Quiz
                                </button>
                            {% endif %}
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteQuiz()">
                                <i class="fas fa-trash"></i> Delete Quiz
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 class="text-primary">{{ stats.total_questions }}</h4>
                            <small>Questions</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-success">{{ stats.total_attempts }}</h4>
                            <small>Attempts</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-warning">{{ stats.completed_attempts }}</h4>
                            <small>Completed</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 class="text-info">{{ stats.average_score }}</h4>
                            <small>Avg Score</small>
                        </div>
                        <div class="col-4">
                            <h4 class="{% if quiz.is_full %}text-danger{% else %}text-primary{% endif %}">
                                {{ quiz.current_participants }}/{{ quiz.participant_limit }}
                            </h4>
                            <small>Participants</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-success">{{ quiz.available_spots }}</h4>
                            <small>Spots Left</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Sharing -->
    {% if quiz.is_active %}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="alert alert-success">
                <h5><i class="fas fa-share-alt"></i> Share Quiz Link</h5>
                <p class="mb-2">Participants can join the quiz using this link:</p>
                <div class="input-group">
                    <input type="text" class="form-control" id="quizLink" 
                           value="{{ request.url_root }}event/{{ event.id }}/quiz/play" readonly>
                    <button class="btn btn-outline-secondary" onclick="copyQuizLink()">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="alert alert-info">
                <h5><i class="fas fa-qrcode"></i> Mobile QR Code</h5>
                <p class="mb-2">Mobile users can scan this QR code to join:</p>
                <div class="text-center mb-2">
                    <img src="{{ url_for('generate_quiz_qr', event_id=event.id) }}" 
                         alt="Quiz QR Code" 
                         class="img-fluid" 
                         style="max-width: 150px;">
                </div>
                <div class="btn-group w-100">
                    <a href="{{ url_for('generate_quiz_qr', event_id=event.id) }}" 
                       class="btn btn-outline-info btn-sm" 
                       download="quiz_qr_{{ event.name|replace(' ', '_') }}.png">
                        <i class="fas fa-download"></i> Download QR
                    </a>
                    <button class="btn btn-outline-secondary btn-sm" onclick="printQR()">
                        <i class="fas fa-print"></i> Print QR
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Questions Management -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-question-circle"></i> Questions ({{ stats.total_questions }})</h5>
                    <div class="btn-group">
                        <a href="{{ url_for('add_quiz_question', event_id=event.id) }}" class="btn btn-success btn-sm">
                            <i class="fas fa-plus"></i> Add Question
                        </a>
                        <a href="{{ url_for('upload_quiz_questions', event_id=event.id) }}" class="btn btn-primary btn-sm">
                            <i class="fas fa-upload"></i> Upload CSV
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if questions %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th width="5%">#</th>
                                        <th width="60%">Question</th>
                                        <th width="15%">Correct Answer</th>
                                        <th width="10%">Points</th>
                                        <th width="10%">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for question in questions %}
                                    <tr>
                                        <td>{{ question.question_order }}</td>
                                        <td>
                                            <div class="question-preview">
                                                {{ question.question_text[:100] }}
                                                {% if question.question_text|length > 100 %}...{% endif %}
                                            </div>
                                            <small class="text-muted">
                                                A: {{ question.option_a[:30] }}...
                                                B: {{ question.option_b[:30] }}...
                                            </small>
                                        </td>
                                        <td>
                                            <span class="badge bg-success">{{ question.correct_answer }}</span>
                                        </td>
                                        <td>{{ question.points }}</td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" 
                                                    onclick="deleteQuestion({{ question.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-question-circle fa-3x text-muted mb-3"></i>
                            <h5>No Questions Added</h5>
                            <p class="text-muted">Start by adding questions manually or uploading a CSV file.</p>
                            <div class="mt-3">
                                <a href="{{ url_for('add_quiz_question', event_id=event.id) }}" class="btn btn-success">
                                    <i class="fas fa-plus"></i> Add First Question
                                </a>
                                <a href="{{ url_for('upload_quiz_questions', event_id=event.id) }}" class="btn btn-primary ms-2">
                                    <i class="fas fa-upload"></i> Upload CSV
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Attempts -->
    {% if attempts %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-users"></i> Recent Attempts</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Participant</th>
                                    <th>Score</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                    <th>Started</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for attempt in attempts[-10:] %}
                                <tr>
                                    <td>{{ attempt.participant.name }}</td>
                                    <td>
                                        <span class="badge bg-primary">{{ attempt.score }}</span>
                                    </td>
                                    <td>
                                        {% if attempt.is_completed %}
                                            <span class="badge bg-success">Completed</span>
                                        {% else %}
                                            <span class="badge bg-warning">In Progress</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if attempt.total_time_taken %}
                                            {{ attempt.total_time_taken }}s
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>{{ attempt.started_at.strftime('%H:%M') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function startQuiz() {
    if (confirm('Are you sure you want to start the quiz? This will allow participants to join.')) {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch(`/event/{{ event.id }}/quiz/start`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error occurred');
        });
    }
}

function endQuiz() {
    if (confirm('Are you sure you want to end the quiz? This will stop all participation.')) {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch(`/event/{{ event.id }}/quiz/end`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error occurred');
        });
    }
}

function copyQuizLink() {
    const linkInput = document.getElementById('quizLink');
    linkInput.select();
    linkInput.setSelectionRange(0, 99999);
    document.execCommand('copy');
    
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i> Copied!';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-success');
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }, 2000);
}

function deleteQuestion(questionId) {
    if (confirm('Are you sure you want to delete this question?')) {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch(`/event/{{ event.id }}/quiz/questions/${questionId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error occurred');
        });
    }
}

function deleteQuiz() {
    const quizTitle = "{{ quiz.title }}";
    const participantCount = {{ stats.total_attempts }};
    
    if (confirm(`âš ï¸ WARNING: This will permanently delete the entire quiz "${quizTitle}" and ALL related data including:\n\nâ€¢ ${participantCount} participant attempts\nâ€¢ All quiz questions\nâ€¢ All quiz answers\nâ€¢ Quiz configuration\n\nThis action CANNOT be undone!\n\nAre you sure you want to delete this quiz?`)) {
        const userConfirmation = prompt('Type "DELETE QUIZ" to confirm:');
        if (userConfirmation === 'DELETE QUIZ') {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            fetch(`/event/{{ event.id }}/quiz/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.href = `/event/{{ event.id }}/dashboard`;
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Network error occurred');
            });
        } else {
            alert('Quiz deletion cancelled - incorrect confirmation text.');
        }
    }
}

function resetQuiz() {
    const participantCount = {{ stats.total_attempts }};
    
    if (confirm(`âš ï¸ This will reset the quiz and remove all participant data:\n\nâ€¢ ${participantCount} participant attempts will be deleted\nâ€¢ All quiz answers will be removed\nâ€¢ Quiz will be stopped and reset to inactive\nâ€¢ Questions and configuration will be kept\n\nParticipants will need to rejoin the quiz.\n\nAre you sure you want to reset this quiz?`)) {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch(`/event/{{ event.id }}/quiz/reset`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Network error occurred');
        });
    }
}

function printQR() {
    const qrImg = document.querySelector('img[alt="Quiz QR Code"]');
    const printWindow = window.open('', '', 'width=400,height=400');
    printWindow.document.write(`
        <html>
        <head>
            <title>Quiz QR Code</title>
            <style>
                body { text-align: center; padding: 20px; font-family: Arial, sans-serif; }
                img { max-width: 300px; }
                h3 { margin-bottom: 10px; }
                p { font-size: 12px; color: #666; }
            </style>
        </head>
        <body>
            <h3>Join Quiz: {{ event.name }}</h3>
            <img src="${qrImg.src}" alt="Quiz QR Code">
            <p>Scan with your mobile device to join the quiz</p>
            <p>${window.location.origin}/event/{{ event.id }}/quiz/play</p>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
}
</script>
{% endblock %}